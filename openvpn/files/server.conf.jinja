{%- from "openvpn/map.jinja" import openvpn with context -%}
{%- set server = openvpn.get('server', {}) -%}

{%- if server.local is defined %}
local {{ server.local }}
{%- endif %}
port {{ server.get('port', '1194') }}
proto {{Â server.get('proto', 'tcp-server') }}
dev {{ server.get('dev', 'tun') }}

ca /etc/openvpn/ssl/ca.crt
cert /etc/openvpn/ssl/server.crt
key /etc/openvpn/ssl/server.key
dh /etc/openvpn/ssl/dh2048.pem

server {{ server.network }} {{ server.netmask }}

ifconfig-pool-persist ipp.txt

{%- for route in server.get('routes', []) %}
push "route {{ route.network }} {{ route.netmask }}"
{%- endfor %}

{%- if server.get('redirect_gateway', False) %}
push "redirect-gateway def1 bypass-dhcp"
{%- endif %}

{%- if server.get("client_to_client", False) %}
client-to-client
{%- endif %}

{%- if server.get("duplicate_cn", False) %}
duplicate-cn
{%- endif %}

{%- for dhcp_option in server.get('dhcp_options', []) %}
push "dhcp-option {{ dhcp_option.name }} {{ dhcp_option.value }}"
{%- endfor %}

keepalive 10 60
inactive 600

{%- if server.ssl.get('ta', False) %}
tls-auth /etc/openvpn/ssl/ta.key 0
{%- endif %}


{%- if server.get('max_clients', False) %}
max-clients {{ server.max_clients }}
{%- endif %}

{%- if server.get('nobody', False) %}
user nobody
group nobody
{%- endif %}

persist-key
persist-tun

status openvpn-status.log
;log         openvpn.log
;log-append  openvpn.log
verb {{ server.get('verb', 3) }}

{%- if server.get('comp_lzo', True) %}
comp-lzo
{%- endif %}

explicit-exit-notify 1

{%- for parameter in server.get('parameters', []) %}
{{ parameter }}
{%- endfor %}